<%= turbo_frame_start params[:frame_name] %>

<%
  fields_by_panel = {}
  has_one_panels = []
  has_many_panels = []
  has_as_belongs_to_many_panels = []

  # abort @resource.get_fields.inspect
  @resource.get_fields.each do |field|
    if field.is_a? Avo::Fields::HasOneField and @reflection.blank?
      has_one_panels << field
    elsif field.is_a? Avo::Fields::HasManyField and @reflection.blank?
      has_many_panels << field
    elsif field.is_a? Avo::Fields::HasAndBelongsToManyField and @reflection.blank?
      has_as_belongs_to_many_panels << field
    else
      fields_by_panel[field.panel_name] ||= []
      fields_by_panel[field.panel_name] << field
    end
  end
%>

<div data-model-id="<%= @model.id %>">
  <% @resource.panels.each do |resource_panel| %>
    <%= panel(title: resource_panel[:name]) do |c| %>
      <% c.with :tools do %>
        <% if resource_panel[:name] == @resource.default_panel_name %>
          <%= render 'actions' %>

          <% if @reflection.present? && @model.present? %>
            <%= a_link resource_detach_path(params[:resource_name], params[:id], params[:related_name], params[:related_id]), color: 'indigo', method: :delete, data: { confirm: "Are you sure you want to detach this #{@resource.singular_name}." } do %>
              <%= svg 'media/svgs/trash.svg' %> <%= t('avo.detach_item', { item: @resource.singular_name }).capitalize %>
            <% end %>
          <% else %>
            <%= a_link url_for(:back) do %>
              <%= svg 'media/svgs/arrow-left.svg' %> <%= t('avo.go_back') %>
            <% end %>

            <% if @authorization.set_record(@model).authorize_action(:destroy, raise_exception: false) %>
              <%= a_link resource_path(@model), color: 'red', variant: 'outlined', method: :delete, data: {confirm: 'Are you sure?'} do %>
                <%= svg 'media/svgs/trash.svg' %> <%= t('avo.delete').capitalize %>
              <% end %>
            <% end %>

            <% if @authorization.set_record(@model).authorize_action(:edit, raise_exception: false) %>
              <%= a_link edit_resource_path(@model), color: 'indigo' do %>
                <%= svg 'media/svgs/edit.svg' %> <%= t('avo.edit').capitalize %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>

      <% c.with :body do %>
        <% if fields_by_panel[resource_panel[:name]].present? %>
          <% fields_by_panel[resource_panel[:name]].each_with_index do |field, index| %>
            <%= show_field field, index, @resource %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

    <%# @resource.get_fields(panel: resource_panel[:name]).each_with_index do |field, index| %>
      <%#= show_field field, index, @resource %>
    <%# end %>
  <% end %>

  <% if has_one_panels.present? %>
    <% has_one_panels.each_with_index do |field, index| %>
      <%= show_field field, index, @resource %>
    <% end %>
  <% end %>

  <% if has_many_panels.present? %>
    <% has_many_panels.each_with_index do |field, index| %>
      <%= show_field field, index, @resource %>
    <% end %>
  <% end %>

  <% if has_as_belongs_to_many_panels.present? %>
    <% has_as_belongs_to_many_panels.each_with_index do |field, index| %>
      <%= show_field field, index, @resource %>
    <% end %>
  <% end %>
</div>

<%= turbo_frame_end params[:frame_name] %>
