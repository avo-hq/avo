<template>
  <div>
    <panel>
      <template #heading>
        {{resourceNamePlural}}
      </template>

      <template #tools>
        <div class="flex justify-between items-center mb-4 w-full">
          <div>
            <resources-search
              :resource-name="resourceName"
              :via-resource-name="viaResourceName"
              :via-resource-id="viaResourceId"
              />
          </div>
          <div>
            <router-link
              :to="{
                name: 'new',
                params: {
                  resourceName: resourceName,
                },
              }"
              class="button"
            >Create new {{resourceNameSingular}}</router-link>
          </div>
        </div>
      </template>

      <template #content>
        <template>
          <div class="flex justify-between items-center py-4">
            <resources-filter
              @change-per-page="changePerPage"
              :per-page="perPage"
              :filters="filters"
              :applied-filters="appliedFilters"
              @change-filter="changeFilter"
            />
          </div>

          <div class="w-full overflow-auto min-h-28 flex flex-col">
            <loading-overlay class="relative" v-if="resources.length === 0 && isLoading"/>
            <div class="relative flex-1 flex" v-else>
              <loading-overlay v-if="isLoading" />

              <resource-table
                v-if="resources && resources.length > 0"
                :resources="resources"
                :resource-name="resourceName"
                :sort-by="sortBy"
                :sort-direction="sortDirection"
                :via-resource-name="viaResourceName"
                :via-resource-id="viaResourceId"
                @sort="changeSortBy"
                ></resource-table>

                <div class="flex-1 flex items-center justify-center" v-else>
                  No {{resourceNamePlural | toLowerCase}} found
                </div>
            </div>

            <paginate
              v-show="totalPages > 1"
              v-model="page"
              ref="paginate"
              :page-count="totalPages"
              :click-handler="changePageFromPagination"
              :prev-text="'Prev'"
              :next-text="'Next'"
              :no-li-surround="true"
              container-class="avo-pagination flex justify-end px-4"
              page-class="pagination-button"
              page-link-class="button select-none rounded-none focus:outline-none"
              active-class="active"
              prev-link-class="button rounded-none focus:outline-none"
              next-link-class="button rounded-none focus:outline-none"
              class="py-4 select-none"
            ></paginate>
          </div>
        </template>
      </template>
    </panel>
  </div>
</template>

<script>
import Api from '@/js/Api'
import URI from 'urijs'
import isNull from 'lodash/isNull'
import isUndefined from 'lodash/isUndefined'
import pluralize from 'pluralize'

export default {
  name: 'ResourceIndex',
  data: () => ({
    resources: [],
    totalPages: 0,
    page: 0,
    perPage: 25,
    sortBy: '',
    sortDirection: '',
    isLoading: true,
    filters: [],
    appliedFilters: {},
    oldQueryUrl: '',
  }),
  props: [
    'resourceName',
    'viaResourceName',
    'viaResourceId',
  ],
  filters: {
    toLowerCase(value) {
      return value.toLowerCase()
    },
  },
  computed: {
    resourceNameSingular() {
      return pluralize(this.resourceName, 1)
    },
    resourceNamePlural() {
      return this.resourceName.charAt(0).toUpperCase() + this.resourceName.slice(1)
    },
    relatedResourcePage() {
      return `${this.resourceName}_page`
    },
    newQueryParams() {
      return {
        name: this.viaResourceName ? 'show' : 'index',
        params: this.params,
        query: this.query,
      }
    },
    params() {
      return {
        resourceName: this.viaResourceName ? this.viaResourceName : this.resourceName,
        resourceId: this.viaResourceId ? this.viaResourceId : null,
      }
    },
    query() {
      const params = {}

      if (this.page === '' || Number.isNaN(this.page) || isUndefined(this.page) || isNull(this.page) || this.page === 1) {
        delete params.page
      } else {
        params.page = this.page
      }

      if (this.viaResourceName) {
        params[this.relatedResourcePage] = params.page

        delete params.page
      }

      if (this.perPage === '' || Number.isNaN(this.perPage) || isUndefined(this.perPage) || isNull(this.perPage) || this.perPage === 25) {
        delete params.per_page
      } else {
        // eslint-disable-next-line camelcase
        params.per_page = this.perPage
      }

      if (Object.keys(this.appliedFilters).length > 0) {
        params.filters = this.encodedFilters
      } else {
        delete params.filters
      }

      // eslint-disable-next-line camelcase
      if (this.sortBy !== '') params.sort_by = this.sortBy
      // eslint-disable-next-line camelcase
      if (this.sortDirection !== '') params.sort_direction = this.sortDirection

      return params
    },
    encodedFilters() {
      return btoa(JSON.stringify(this.appliedFilters))
    },
    queryUrl() {
      const url = new URI()
      url.path(`/avocado/avocado-api/${this.resourceName.toLowerCase()}`)

      /* eslint-disable camelcase */
      let query = {
        filters: this.encodedFilters,
        page: this.page,
        per_page: this.perPage,
        sort_by: this.sortBy,
        sort_direction: this.sortDirection,
      }

      if (this.viaResourceName) {
        query = {
          ...query,
          via_resource_name: this.viaResourceName.toLowerCase(),
          via_resource_id: this.viaResourceId,
        }
      }
      /* eslint-enable camelcase */

      url.query(query)

      return url.toString()
    },
  },
  methods: {
    updateQueryParams() {
      this.$router.push(this.newQueryParams)
    },
    changeFilter(args) {
      this.setFilterValue(args)
      this.updateQueryParams()
    },
    changePerPage(perPage) {
      this.setPerPage(perPage)
      this.updateQueryParams()
    },
    changePageFromPagination(page) {
      this.setPage(page)
      this.updateQueryParams()
    },
    async getResources() {
      if (this.oldQueryUrl === this.queryUrl) return
      this.oldQueryUrl = this.queryUrl

      this.isLoading = true

      const { data } = await Api.get(this.queryUrl)

      this.resources = data.resources
      this.totalPages = data.total_pages

      this.isLoading = false
    },
    async getFilters() {
      const { data } = await Api.get(`/avocado/avocado-api/${this.resourceName}/filters`)

      this.filters = data.filters
    },
    changeSortDirection(by) {
      if (this.sortBy !== '' && this.sortBy !== by) {
        this.sortDirection = 'desc'

        return
      }

      switch (this.sortDirection) {
        case '':
          this.sortDirection = 'desc'
          break
        case 'desc':
          this.sortDirection = 'asc'
          break
        case 'asc':
          this.sortDirection = ''
          break
        default:
          this.sortDirection = ''
          break
      }
    },
    changeSortBy(by) {
      const newBy = this.sortDirection === 'asc' ? '' : by

      this.changeSortDirection(by)
      this.setSortBy(newBy)
      this.updateQueryParams()
    },
    setPage(page) {
      this.page = isUndefined(page) ? 1 : parseInt(page, 10)
    },
    setPerPage(perPage) {
      this.perPage = isUndefined(perPage) ? 25 : parseInt(perPage, 10)
    },
    setSortBy(by) {
      this.sortBy = isUndefined(by) ? '' : by
    },
    setSortDirection(direction) {
      this.sortDirection = isUndefined(direction) ? '' : direction
    },
    setFilterValue(args) {
      Object.keys(args).forEach((filterClass) => {
        const value = args[filterClass]

        if (value === '' || value === '-') {
          this.$delete(this.appliedFilters, filterClass)
        } else {
          this.$set(this.appliedFilters, filterClass, value)
        }
      })
    },
    async initQueryParams() {
      let page = 1
      let perPage = 25
      let sortBy = ''
      let sortDirection = ''
      let filters = ''

      page = URI(window.location.toString()).query(true).page
      // @todo: do the same with the other params (sort, filter, etc.)
      page = URI(window.location.toString()).query(true)[this.relatedResourcePage]
      perPage = URI(window.location.toString()).query(true).per_page
      sortBy = URI(window.location.toString()).query(true).sort_by
      sortDirection = URI(window.location.toString()).query(true).sort_direction
      filters = URI(window.location.toString()).query(true).filters

      this.setPage(page)
      this.setPerPage(perPage)
      this.setSortBy(sortBy)
      this.setSortDirection(sortDirection)
      if (filters) this.setFilterValue(JSON.parse(atob(filters)))

      await this.getResources()
    },
  },
  watch: {
    $route: 'getResources',
  },
  async mounted() {
    this.getFilters()
    this.initQueryParams()
  },
}
</script>

<style slang="postcss">
/* @todo: fix loaders to support lang= */
.avo-pagination {
  a {
    @apply shadow-md;
  }
  a.active {
    @apply bg-gray-300 border-gray-300;
  }
  a.disabled {
    @apply text-gray-500;

    &:hover {
      @apply bg-white;
    }
  }
}
</style>
