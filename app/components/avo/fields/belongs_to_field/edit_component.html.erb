<% if @field.types.present? %>
  <div data-controller="belongs-to-field">
    <%= edit_field_wrapper field: @field, index: @index, form: @form, resource: @resource, displayed_in_modal: @displayed_in_modal do %>
      <%= @form.select "#{@field.foreign_key}_type", @field.types.map { |type| [type.to_s.underscore.humanize, type.to_s] },
        {
          include_blank: @field.placeholder,
        },
        {
          class: helpers.input_classes('w-full', has_error: @field.model_errors.include?(@field.id)),
          disabled: disabled,
          'data-belongs-to-field-target': "select",
          'data-action': 'change->belongs-to-field#changedType'
        }
        %>
      <%
        # If the select field is disabled, no value will be sent. It's how HTML works.
        # Thus the extra hidden field to actually send the related id to the server.
        if disabled %>
        <%= @form.hidden_field "#{@field.foreign_key}_type" %>
      <% end %>
    <% end %>
    <% @field.types.each do |type| %>
      <div class="hidden"
        data-belongs-to-field-target="type"
        data-type="<%= type %>"
      >
        <%= edit_field_wrapper field: @field, index: @index, form: @form, resource: @resource, displayed_in_modal: @displayed_in_modal, label: type.to_s.underscore.humanize do %>
          <%= @form.select "#{@field.foreign_key}_id", @field.values_for_type(type),
            {
              include_blank: @field.placeholder,
            },
            {
              class: helpers.input_classes('w-full', has_error: @field.model_errors.include?(@field.id)),
              disabled: disabled
            }
            %>
          <%
            # If the select field is disabled, no value will be sent. It's how HTML works.
            # Thus the extra hidden field to actually send the related id to the server.
            if disabled %>
            <%= @form.hidden_field "#{@field.foreign_key}_id" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <%= edit_field_wrapper field: @field, index: @index, form: @form, resource: @resource, displayed_in_modal: @displayed_in_modal do %>
    <% if @field.searchable %>
      <div data-controller="search" class="resource-search flex items-center h-full w-full" data-turbo-remove-before-cache>
        <div class="w-full hidden"
          data-search-target="autocomplete"
          data-search-resource="<%= @field.target_resource.model_key %>"
          data-translation-keys='{"no_item_found": "<%= I18n.translate 'avo.no_item_found' %>"}'
          data-via-association="belongs_to"
        ></div>
        <div class="relative w-full" autocomplete="off">
          <%= @form.text_field @field.foreign_key,
            value: @field.field_label,
            class: helpers.input_classes('w-full', has_error: @field.model_errors.include?(@field.id)), 'data-search-target': 'button clearValue',
            placeholder: @field.placeholder,
            disabled: true %>
          <div class="absolute top-1/2 left-auto right-2 -mt-2 cursor-pointer hidden text-gray-500"
            data-tippy="tooltip"
            data-search-target="clearButton"
            title="<%= I18n.translate 'avo.clear_value' %>"
            data-action="click->search#clearValue"
            ><%= helpers.svg 'x', class: 'h-4' %></div>
        </div>
        <%= @form.hidden_field @field.foreign_key, value: @field.field_value, 'data-search-target': 'hiddenId clearValue' %>
      </div>
    <% else %>
      <%= @form.select @field.foreign_key, @field.options.map { |o| [o[:label], o[:value]] },
        { include_blank: @field.placeholder },
        {
          class: helpers.input_classes('w-full', has_error: @field.model_errors.include?(@field.id)),
          disabled: disabled
        }
        %>
      <%
        # If the select field is disabled, no value will be sent. It's how HTML works.
        # Thus the extra hidden field to actually send the related id to the server.
        if disabled %>
        <%= @form.hidden_field @field.foreign_key %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
